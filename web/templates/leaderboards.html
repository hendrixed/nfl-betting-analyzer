{% extends "base.html" %}

{% block title %}Leaderboards{% endblock %}

{% block content %}
<div class="row mb-3">
  <div class="col-12">
    <h1 class="mb-3"><i class="fas fa-ranking-star"></i> Leaderboards</h1>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header"><h5 class="mb-0"><i class="fas fa-filter"></i> Filters</h5></div>
      <div class="card-body">
        <form method="get" action="/web/leaderboards">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label" for="stat">Stat</label>
              <select class="form-select" id="stat" name="stat">
                {% set s = (stat or 'fantasy_points_ppr') %}
                <option value="fantasy_points_ppr" {% if s=='fantasy_points_ppr' %}selected{% endif %}>Fantasy PPR</option>
                <option value="passing_yards" {% if s=='passing_yards' %}selected{% endif %}>Passing Yards</option>
                <option value="rushing_yards" {% if s=='rushing_yards' %}selected{% endif %}>Rushing Yards</option>
                <option value="receiving_yards" {% if s=='receiving_yards' %}selected{% endif %}>Receiving Yards</option>
                <option value="receptions" {% if s=='receptions' %}selected{% endif %}>Receptions</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="season">Season</label>
              <input class="form-control" type="number" id="season" name="season" value="{{ season or '' }}" placeholder="e.g., 2024">
            </div>
            <div class="col-md-3">
              <label class="form-label" for="position">Position</label>
              <select class="form-select" id="position" name="position">
                <option value="">All</option>
                <option value="QB" {% if position=='QB' %}selected{% endif %}>QB</option>
                <option value="RB" {% if position=='RB' %}selected{% endif %}>RB</option>
                <option value="WR" {% if position=='WR' %}selected{% endif %}>WR</option>
                <option value="TE" {% if position=='TE' %}selected{% endif %}>TE</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label" for="page_size">Page Size</label>
              <input class="form-control" type="number" id="page_size" name="page_size" value="{{ page_size or 25 }}" min="1" max="200">
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-md-3">
              <label class="form-label" for="sort">Sort By</label>
              <select class="form-select" id="sort" name="sort">
                <option value="value" {% if sort=='value' %}selected{% endif %}>Value</option>
                <option value="name" {% if sort=='name' %}selected{% endif %}>Name</option>
                <option value="team" {% if sort=='team' %}selected{% endif %}>Team</option>
                <option value="position" {% if sort=='position' %}selected{% endif %}>Position</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="order">Order</label>
              <select class="form-select" id="order" name="order">
                <option value="desc" {% if order=='desc' %}selected{% endif %}>Descending</option>
                <option value="asc" {% if order=='asc' %}selected{% endif %}>Ascending</option>
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-primary w-100" type="submit">Apply</button>
            </div>
          </div>
          <div class="mt-3">
            <a class="btn btn-outline-secondary" href="/web/leaderboards">Reset</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-end mb-2">
      {% set export_base = '/api/browse/leaderboard/export.csv?'
         + ('stat=' ~ stat ~ '&') | safe
         + ('season=' ~ season ~ '&' if season) | safe
         + ('position=' ~ position ~ '&' if position) | safe
         + ('sort=' ~ sort ~ '&') | safe
         + ('order=' ~ order ~ '&') | safe
         + ('page_size=' ~ page_size ~ '&') | safe
         + ('page=' ~ page ~ '&') | safe %}
      <div class="btn-group">
        <a class="btn btn-sm btn-outline-success" href="{{ export_base }}" target="_blank">
          <i class="fas fa-file-csv"></i> Export Current Page
        </a>
        <a class="btn btn-sm btn-success" href="{{ export_base }}all=true" target="_blank">
          <i class="fas fa-download"></i> Export All
        </a>
      </div>
    </div>
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Top {{ rows|length }} - {{ stat|replace('_',' ')|title }}{% if season %} ({{ season }}){% endif %}{% if position %} - {{ position }}{% endif %}</h5>
      </div>
      <div class="card-body">
        {% if rows %}
        <div class="table-responsive">
          <table class="table table-striped table-sm">
            <thead>
              <tr>
                <th>#</th>
                <th>
                  {% set base = '/web/leaderboards?'
                    + ('stat=' ~ stat ~ '&') | safe
                    + ('season=' ~ season ~ '&' if season) | safe
                    + ('position=' ~ position ~ '&' if position) | safe
                    + ('page_size=' ~ page_size ~ '&') | safe %}
                  {% set next_order = 'asc' if sort!='name' else ('asc' if order=='desc' else 'desc') %}
                  <a href="{{ base }}sort=name&order={{ next_order }}&page=1">Player
                    {% if sort=='name' %}
                      <i class="fas fa-sort-{{ 'up' if order=='asc' else 'down' }} ms-1"></i>
                    {% endif %}
                  </a>
                </th>
                <th>
                  {% set next_order = 'asc' if sort!='position' else ('asc' if order=='desc' else 'desc') %}
                  <a href="{{ base }}sort=position&order={{ next_order }}&page=1">Pos
                    {% if sort=='position' %}
                      <i class="fas fa-sort-{{ 'up' if order=='asc' else 'down' }} ms-1"></i>
                    {% endif %}
                  </a>
                </th>
                <th>
                  {% set next_order = 'asc' if sort!='team' else ('asc' if order=='desc' else 'desc') %}
                  <a href="{{ base }}sort=team&order={{ next_order }}&page=1">Team
                    {% if sort=='team' %}
                      <i class="fas fa-sort-{{ 'up' if order=='asc' else 'down' }} ms-1"></i>
                    {% endif %}
                  </a>
                </th>
                <th class="text-end">
                  {% set next_order = 'desc' if sort!='value' else ('asc' if order=='desc' else 'desc') %}
                  <a class="float-end" href="{{ base }}sort=value&order={{ next_order }}&page=1">Value
                    {% if sort=='value' %}
                      <i class="fas fa-sort-{{ 'up' if order=='asc' else 'down' }} ms-1"></i>
                    {% endif %}
                  </a>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for r in rows %}
              <tr>
                <td>{{ loop.index }}</td>
                <td><a href="/player/{{ r.player_id }}">{{ r.name }}</a></td>
                <td>{{ r.position }}</td>
                <td><a href="/team/{{ r.team }}">{{ r.team }}</a></td>
                <td class="text-end">{{ '%.1f'|format(r.value) if stat=='fantasy_points_ppr' else '%.0f'|format(r.value) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info mb-0">No leaderboard data available for the selected filters.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% if total and page and page_size %}
{% set last_page = (total // page_size) + (1 if (total % page_size) else 0) %}
<div class="d-flex justify-content-between align-items-center mt-3">
  <div class="text-muted small">
    Showing {{ ((page-1)*page_size + 1) if total>0 else 0 }}â€“{{ ((page-1)*page_size + rows|length) }} of {{ total }}
  </div>
  <div>
    {% set base = '/web/leaderboards?'
      + ('stat=' ~ stat ~ '&') | safe
      + ('season=' ~ season ~ '&' if season) | safe
      + ('position=' ~ position ~ '&' if position) | safe
      + ('sort=' ~ sort ~ '&') | safe
      + ('order=' ~ order ~ '&') | safe
      + ('page_size=' ~ page_size ~ '&') | safe %}
    <a class="btn btn-sm btn-outline-secondary {% if page<=1 %}disabled{% endif %}" href="{{ base }}page={{ page-1 }}">Prev</a>
    <span class="mx-2 small">Page {{ page }} / {{ last_page if last_page>0 else 1 }}</span>
    <a class="btn btn-sm btn-outline-secondary {% if page>=last_page %}disabled{% endif %}" href="{{ base }}page={{ page+1 }}">Next</a>
  </div>
</div>
{% endif %}
{% endblock %}
